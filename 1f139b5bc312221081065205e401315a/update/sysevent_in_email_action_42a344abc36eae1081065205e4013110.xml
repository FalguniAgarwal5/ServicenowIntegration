<?xml version="1.0" encoding="UTF-8"?><record_update sys_domain="global" table="sysevent_in_email_action">
    <sysevent_in_email_action action="INSERT_OR_UPDATE">
        <action>record_action</action>
        <active>true</active>
        <assignment_operator/>
        <condition_script/>
        <description/>
        <event_name>email.read</event_name>
        <filter_condition table="sys_email">subjectLIKEBilling Inquiry^EQ<item endquery="false" field="subject" goto="false" newquery="false" operator="LIKE" or="false" value="Billing Inquiry"/>
            <item endquery="true" field="" goto="false" newquery="false" operator="=" or="false" value=""/>
        </filter_condition>
        <from/>
        <name>Billing Inquiry Response</name>
        <order>-30</order>
        <reply_email/>
        <required_roles/>
        <script><![CDATA[(function runAction(/*GlideRecord*/ current, /*GlideRecord*/ event, /*EmailWrapper*/ email, /*ScopedEmailLogger*/ logger, /*EmailClassifier*/ classifier) {

	(function runInboundEmailAction() {
    var emailBody = email.body_text;

    
    var patientIdMatch = emailBody.match(/Patient ID:\s*(PAT\d+)/i);
    if (!patientIdMatch) {
        gs.print("Billing Inquiry: Patient ID not found in email body.");
        return;
    }

    var patientId = patientIdMatch[1].trim();

    
    var billingGR = new GlideRecord('u_billing');
    billingGR.addQuery('u_patient_id', patientId);
    billingGR.orderByDesc('sys_created_on'); 
    billingGR.query();

    if (billingGR.next()) {
        
        var response = "Hello,\n\nHere are the billing details for Patient ID: " + patientId + "\n";
        response += "Total Amount: " + billingGR.u_total_amount + "\n";
        response += "Status: " + billingGR.u_status + "\n";
        response += "\nThank you.\nHealthcare Billing Team";

        // Send reply
        var reply = new GlideEmailOutbound();
        reply.setSubject("Billing Details for Patient ID: " + patientId);
        reply.setBody(response);
        reply.setReplyTo(email.origemail); // Sends back to original sender
        reply.setFrom("noreply@yourdomain.com"); // Set appropriate sender
        reply.send();
    } else {
        // If no billing record found
        var noDataResponse = "Hello,\n\nWe could not find any billing details for Patient ID: " + patientId + ".\n";
        noDataResponse += "Please verify the ID or contact the billing department.\n\nThank you.";

        var replyNoData = new GlideEmailOutbound();
        replyNoData.setSubject("Billing Inquiry - No Data Found");
        replyNoData.setBody(noDataResponse);
        replyNoData.setReplyTo(email.origemail);
        replyNoData.setFrom("noreply@yourdomain.com");
        replyNoData.send();
    }
})();

})(current, event, email, logger, classifier);]]></script>
        <stop_processing>false</stop_processing>
        <sys_class_name>sysevent_in_email_action</sys_class_name>
        <sys_created_by>admin</sys_created_by>
        <sys_created_on>2025-07-11 00:46:27</sys_created_on>
        <sys_domain>global</sys_domain>
        <sys_domain_path>/</sys_domain_path>
        <sys_id>42a344abc36eae1081065205e4013110</sys_id>
        <sys_mod_count>1</sys_mod_count>
        <sys_name>Billing Inquiry Response</sys_name>
        <sys_overrides/>
        <sys_package display_value="Healthcare Management Application" source="1f139b5bc312221081065205e401315a">1f139b5bc312221081065205e401315a</sys_package>
        <sys_policy/>
        <sys_scope display_value="Healthcare Management Application">1f139b5bc312221081065205e401315a</sys_scope>
        <sys_update_name>sysevent_in_email_action_42a344abc36eae1081065205e4013110</sys_update_name>
        <sys_updated_by>admin</sys_updated_by>
        <sys_updated_on>2025-07-16 09:56:24</sys_updated_on>
        <table>u_billing</table>
        <template/>
        <type>reply</type>
    </sysevent_in_email_action>
    <sys_es_latest_script action="INSERT_OR_UPDATE">
        <id>42a344abc36eae1081065205e4013110</id>
        <sys_created_by>admin</sys_created_by>
        <sys_created_on>2025-07-11 00:46:26</sys_created_on>
        <sys_id>3bb4046bc36eae1081065205e40131ba</sys_id>
        <sys_mod_count>0</sys_mod_count>
        <sys_updated_by>admin</sys_updated_by>
        <sys_updated_on>2025-07-11 00:46:26</sys_updated_on>
        <table>sysevent_in_email_action</table>
        <use_es_latest>true</use_es_latest>
    </sys_es_latest_script>
</record_update>
